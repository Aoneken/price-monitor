<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Price Monitor - Professional Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <div class="app-container">
      <!-- Header with Focus Selector -->
      <header class="app-header">
        <div class="header-left">
          <h1 class="app-title">
            <span class="logo">üìä</span>
            <span>Price Monitor</span>
          </h1>
          <div class="focus-selector">
            <label for="focus-select">Workspace:</label>
            <select id="focus-select" class="focus-dropdown">
              <option value="">Seleccionar...</option>
            </select>
          </div>
          <div class="focus-selector">
            <label for="season-select">Temporada:</label>
            <select id="season-select" class="focus-dropdown">
              <option value="">Seleccionar...</option>
            </select>
          </div>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" onclick="openNewFocusModal()">
            <span class="btn-icon">‚ûï</span>
            <span>Nuevo Workspace</span>
          </button>
        </div>
      </header>

      <!-- Stats Cards -->
      <div id="stats-cards" class="stats-grid" style="display: none">
        <div class="stat-card">
          <div class="stat-icon">üè†</div>
          <div class="stat-content">
            <div class="stat-label">Establecimientos</div>
            <div class="stat-value" id="stat-listings">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-content">
            <div class="stat-label">Temporadas</div>
            <div class="stat-value" id="stat-seasons">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üîç</div>
          <div class="stat-content">
            <div class="stat-label">Scrapes Activos</div>
            <div class="stat-value" id="stat-jobs">0</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <div class="stat-label">Precios Capturados</div>
            <div class="stat-value" id="stat-prices">0</div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Tab Navigation -->
        <nav class="tabs" role="tablist">
          <button
            class="tab active"
            role="tab"
            onclick="switchTab('config', event)"
          >
            <span class="tab-icon">‚öôÔ∏è</span>
            <span>Configuraci√≥n</span>
          </button>
          <button class="tab" role="tab" onclick="switchTab('scraping', event)">
            <span class="tab-icon">üîç</span>
            <span>Scraping</span>
          </button>
          <button class="tab" role="tab" onclick="switchTab('jobs', event)">
            <span class="tab-icon">üìã</span>
            <span>Jobs</span>
          </button>
          <button class="tab" role="tab" onclick="switchTab('database', event)">
            <span class="tab-icon">üóÑÔ∏è</span>
            <span>Base de Datos</span>
          </button>
          <button
            class="tab"
            role="tab"
            onclick="switchTab('analytics', event)"
          >
            <span class="tab-icon">üìà</span>
            <span>An√°lisis</span>
          </button>
        </nav>

        <!-- Tab Contents -->
        <div id="main-content">
          <!-- Configuration Tab -->
          <div id="config-tab" class="tab-content active">
            <div class="subtab-nav">
              <button
                class="subtab-btn active"
                onclick="switchConfigSubtab('settings', event)"
              >
                ‚öôÔ∏è Ajustes
              </button>
              <button
                class="subtab-btn"
                onclick="switchConfigSubtab('seasons', event)"
              >
                üìÖ Temporadas
              </button>
              <button
                class="subtab-btn"
                onclick="switchConfigSubtab('listings', event)"
              >
                üè† Establecimientos
              </button>
            </div>

            <div id="config-settings" class="subtab-content active">
              <div class="empty-state">
                <div class="empty-state-icon">üéØ</div>
                <h3>Selecciona o crea un Workspace</h3>
                <p>
                  Los workspaces te permiten organizar tus temporadas y
                  establecimientos.
                </p>
                <button class="btn btn-primary" onclick="openNewFocusModal()">
                  ‚ûï Crear Primer Workspace
                </button>
              </div>
            </div>

            <div id="config-seasons" class="subtab-content"></div>
            <div id="config-listings" class="subtab-content"></div>
          </div>

          <!-- Scraping Tab -->
          <div id="scraping-tab" class="tab-content">
            <div class="content-section">
              <h2>üîç Lanzar Nuevo Scrape</h2>
              <p class="text-muted">
                Selecciona establecimientos y configura par√°metros para iniciar
                la captura de precios.
              </p>

              <div class="scraping-panel">
                <div class="scraping-form">
                  <h3>Selecci√≥n de Establecimientos</h3>
                  <div
                    id="scraping-listings-selector"
                    class="listings-selector"
                  >
                    <p class="text-muted">Selecciona un workspace primero...</p>
                  </div>

                  <h3 style="margin-top: 2rem">Par√°metros</h3>
                  <form id="bulk-scrape-form">
                    <div class="form-grid">
                      <div class="form-group">
                        <label>Fecha Inicio *</label>
                        <input type="date" id="bulk-start" required />
                      </div>
                      <div class="form-group">
                        <label>Fecha Fin *</label>
                        <input type="date" id="bulk-end" required />
                      </div>
                      <div class="form-group">
                        <label>Hu√©spedes</label>
                        <input
                          type="number"
                          id="bulk-guests"
                          value="2"
                          min="1"
                        />
                      </div>
                      <div class="form-group">
                        <label>Plataforma</label>
                        <select id="bulk-provider">
                          <option value="airbnb">Airbnb (soportado)</option>
                          <option value="booking" disabled>
                            Booking (sin soporte)
                          </option>
                          <option value="expedia" disabled>
                            Expedia (sin soporte)
                          </option>
                        </select>
                      </div>
                      <div class="form-group">
                        <label>Moneda</label>
                        <select id="bulk-currency">
                          <option value="USD">USD</option>
                          <option value="ARS">ARS</option>
                          <option value="EUR">EUR</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-actions">
                      <button type="submit" class="btn btn-primary btn-large">
                        <span class="btn-icon">‚ñ∂Ô∏è</span>
                        <span>Iniciar Scrape</span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Jobs Tab -->
          <div id="jobs-tab" class="tab-content">
            <div class="content-section">
              <div class="section-header">
                <h2>üìã Historial de Jobs</h2>
                <button class="btn btn-secondary" onclick="loadJobs()">
                  <span>üîÑ</span>
                  <span>Actualizar</span>
                </button>
              </div>

              <div id="jobs-list" class="jobs-grid">
                <p class="text-muted">Cargando...</p>
              </div>
            </div>
          </div>

          <!-- Database Tab -->
          <div id="database-tab" class="tab-content">
            <div class="content-section">
              <h2>üóÑÔ∏è Explorador de Base de Datos</h2>

              <div class="db-controls">
                <div class="db-filters">
                  <div class="form-group">
                    <label>Tabla</label>
                    <select id="db-table" onchange="loadDatabaseTable()">
                      <option value="prices">üìä Registros de Precios</option>
                      <option value="listings">üè† Establecimientos</option>
                      <option value="jobs">üìã Jobs de Scraping</option>
                      <option value="seasons">üìÖ Temporadas</option>
                      <option value="workspaces">üè¢ Workspaces</option>
                    </select>
                  </div>

                  <div class="form-group" id="db-listing-filter">
                    <label>Establecimiento</label>
                    <select id="db-listing">
                      <option value="">Todos</option>
                    </select>
                  </div>

                  <div class="form-group" id="db-date-start-filter">
                    <label>Desde</label>
                    <input type="date" id="db-date-start" />
                  </div>

                  <div class="form-group" id="db-date-end-filter">
                    <label>Hasta</label>
                    <input type="date" id="db-date-end" />
                  </div>

                  <button
                    class="btn btn-primary"
                    onclick="applyDatabaseFilters()"
                  >
                    <span>üîç</span>
                    <span>Aplicar Filtros</span>
                  </button>

                  <button
                    class="btn btn-success"
                    onclick="exportDatabaseTable()"
                  >
                    <span>‚¨áÔ∏è</span>
                    <span>Exportar CSV</span>
                  </button>

                  <button
                    class="btn btn-danger"
                    onclick="deleteFilteredRecords()"
                    title="Eliminar registros filtrados"
                  >
                    <span>üóëÔ∏è</span>
                    <span>Vaciar</span>
                  </button>
                </div>

                <div class="db-custom-filters" id="db-custom-filters">
                  <details>
                    <summary>üîß Filtros Avanzados</summary>
                    <div class="custom-filter-builder">
                      <div id="custom-filters-list"></div>
                      <button
                        class="btn btn-sm btn-secondary"
                        onclick="addCustomFilter()"
                      >
                        ‚ûï Agregar Filtro
                      </button>
                    </div>
                  </details>
                </div>
              </div>

              <div class="db-info">
                <span id="db-record-count">0 registros</span>
                <span id="db-page-info">P√°gina 1 de 1</span>
              </div>

              <div id="database-table" class="table-container">
                <div class="loading">Cargando datos...</div>
              </div>

              <div class="db-pagination">
                <button
                  class="btn btn-sm"
                  onclick="prevDatabasePage()"
                  id="db-prev-btn"
                  disabled
                >
                  ‚¨ÖÔ∏è Anterior
                </button>
                <span id="db-page-numbers"></span>
                <button
                  class="btn btn-sm"
                  onclick="nextDatabasePage()"
                  id="db-next-btn"
                >
                  Siguiente ‚û°Ô∏è
                </button>
              </div>
            </div>
          </div>

          <!-- Analytics Tab -->
          <div id="analytics-tab" class="tab-content">
            <div class="content-section">
              <h2>üìà An√°lisis de Precios</h2>

              <div class="analytics-filters">
                <div class="form-group">
                  <label>Fecha Inicio</label>
                  <input
                    type="date"
                    id="analytics-start"
                    onchange="loadAnalytics()"
                  />
                </div>
                <div class="form-group">
                  <label>Fecha Fin</label>
                  <input
                    type="date"
                    id="analytics-end"
                    onchange="loadAnalytics()"
                  />
                </div>
                <div class="form-group">
                  <label>Plataforma</label>
                  <select id="analytics-provider" onchange="loadAnalytics()">
                    <option value="all">Todas</option>
                    <option value="airbnb">Airbnb</option>
                    <option value="booking">Booking</option>
                    <option value="expedia">Expedia</option>
                  </select>
                </div>
                <button class="btn btn-primary" onclick="loadAnalytics()">
                  <span>üîç</span>
                  <span>Actualizar</span>
                </button>
                <button class="btn btn-success" onclick="exportAnalyticsData()">
                  <span>‚¨áÔ∏è</span>
                  <span>Exportar CSV</span>
                </button>
              </div>

              <div class="analytics-listings-selector">
                <h3>Establecimientos</h3>
                <div id="analytics-listings-container">
                  <!-- Checkboxes will be rendered here -->
                </div>
              </div>

              <div class="chart-container">
                <canvas id="analyticsChart"></canvas>
              </div>

              <div id="analytics-stats" class="analytics-stats">
                <!-- Stats will be rendered here -->
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <div id="new-focus-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚ûï Crear Nuevo Workspace</h3>
          <button class="modal-close" onclick="closeModal('new-focus-modal')">
            ‚úï
          </button>
        </div>
        <div class="modal-body">
          <form id="new-focus-form">
            <div class="form-group">
              <label for="workspace-name">Nombre del Workspace *</label>
              <input
                type="text"
                id="workspace-name"
                name="name"
                placeholder="Ej: Patagonia 2025"
                required
              />
            </div>
            <div class="form-actions">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="closeModal('new-focus-modal')"
              >
                Cancelar
              </button>
              <button type="submit" class="btn btn-success">Crear</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div id="delete-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚ö†Ô∏è Confirmar Eliminaci√≥n</h3>
          <button class="modal-close" onclick="closeModal('delete-modal')">
            ‚úï
          </button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div>
              <strong>Esta acci√≥n no se puede deshacer.</strong>
              <p id="delete-message" class="text-muted"></p>
            </div>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal('delete-modal')"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn btn-danger"
              onclick="confirmDelete()"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="scrape-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>üîç Scrape en Progreso</h3>
          <button class="modal-close" onclick="closeModal('scrape-modal')">
            ‚úï
          </button>
        </div>
        <div class="modal-body">
          <div class="progress-section">
            <div class="progress-bar">
              <div id="scrape-progress" class="progress-fill"></div>
            </div>
            <div id="scrape-logs" class="logs-container"></div>
          </div>
          <div class="form-actions">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeModal('scrape-modal')"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toast-container" class="toast-container" aria-live="polite"></div>

    <script src="/static/app.js"></script>
  </body>
</html>
